#!/bin/bash -e


ROOT=`dirname $0`
CI=${CI:-false}
BUILD_FOR=${BUILD_FOR:-""}  # Read BUILD_FOR env variable, default to empty

cd "$ROOT/.."
POSITIONAL=()
SKIP_EXE_BUILD=false
while [[ $# -gt 0 ]]; do
  key="$1"

  case $key in
      --skip-exe-build)
      SKIP_EXE_BUILD=true
      shift
      ;;
      *)
      POSITIONAL+=("$1")
      shift
      ;;
  esac
done

set -- "${POSITIONAL[@]}"

buildForFlathub=false

if [ "$BUILD_FOR" == "flathub" ]; then
    buildForFlathub=true
fi

if [ $buildForFlathub ]; then
    echo "Building for Flathub..."
    echo "Skipping translations - they are handled in the Flathub build process."
else
  # Get translations
  echo "Updating translations..."
  if ! [ -d packages/desktop-client/locale ]; then
      git clone https://github.com/actualbudget/translations packages/desktop-client/locale
  fi
  pushd packages/desktop-client/locale > /dev/null
  git pull
  popd > /dev/null
  packages/desktop-client/bin/remove-untranslated-languages
fi


export NODE_OPTIONS="--max-old-space-size=4096"

yarn workspace plugins-service build
yarn workspace loot-core build:node
yarn workspace @actual-app/web build --mode=desktop # electron specific build

# required for running the sync-server server
yarn workspace loot-core build:browser
yarn workspace @actual-app/web build:browser
yarn workspace @actual-app/sync-server build

yarn workspace desktop-electron update-client

(
    cd packages/desktop-electron;
    yarn clean;

    if [ $SKIP_EXE_BUILD == true ]; then
        echo "Building the dist"
        yarn build:dist
        echo "Skipping exe build"
    else
        if [ "$buildForFlathub" = true ]; then
          yarn build --linux=dir
        else
          yarn build
        fi

        echo "Created desktop-electron package..."
    fi
)
